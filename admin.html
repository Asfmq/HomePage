<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="page-title"></title>
    <meta name="keywords" content="" id="page-keywords">
    <meta name="description" content="" id="page-description">
    <meta name="author" content="" id="page-author">
    <link rel="icon" href="" id="favicon" type="image/x-icon">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <meta name="lsvn" content="djEuNS4x">
    
    <!-- 引入外部 CSS -->
    <link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/4.5.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="assets/css/fontawesome-free5.13.0.css">
    
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-2-M/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap/4.5.3/js/bootstrap.min.js"></script>

    <!-- 在其他脚本之前添加 Sortable.js -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        let configData = {};

        // 从服务器加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                configData = config;

        // 设置页面信息
        document.getElementById('page-title').innerText = config.title;
        document.getElementById('page-keywords').content = config.keywords;
        document.getElementById('page-description').content = config.description;
        document.getElementById('page-author').content = config.author;
        document.getElementById('favicon').href = config.favicon;

        // 设置背景图
        document.body.style.backgroundImage = `url(${config.backgroundImage})`; 

        // 动态生成导航项
        const navItemsContainer = document.getElementById('nav-items');
                navItemsContainer.innerHTML = ''; // 清空现有内容

                // 添加现有导航项
                config.links.navItems.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = "nav-item";
                    li.innerHTML = `<a class="nav-link" href="javascript:void(0)" onclick="showNavDetails(${index}, ${JSON.stringify(item).replace(/"/g, '&quot;')})">${item.name}</a>`;
          navItemsContainer.appendChild(li);
        });

                // 添加"添加导航"按钮
                const addNavLi = document.createElement('li');
                addNavLi.className = "nav-item";
                addNavLi.innerHTML = `
                    <a class="nav-link" href="javascript:void(0)" onclick="addNewNavItem()">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-add"></use>
                        </svg>
                        添加导航
                    </a>
                `;
                navItemsContainer.appendChild(addNavLi);

        // 动态生成分类和链接
        const categoriesContainer = document.getElementById('categories');
                categoriesContainer.innerHTML = ''; // 清空现有内容
                
                config.links.categories.forEach((category, categoryIndex) => {
          const categoryDiv = document.createElement('ul');
          categoryDiv.className = "mylist row";
		  
                    // 添加分类标题
          categoryDiv.innerHTML = `<li class="title">
                        <div class="category-title" onclick="showCategoryDetails(${categoryIndex}, ${JSON.stringify(category).replace(/"/g, '&quot;')})">
			<svg class="icon" aria-hidden="true">
				<use href="${category.icon}"></use>
        	</svg>
                            <span>${category.title}</span>
                        </div>
                    </li>`;
                    
                    // 添加现有链接
          category.links.forEach(link => {
            const linkItem = document.createElement('li');
            linkItem.className = "lylme-3";
                        linkItem.innerHTML = `<a href="javascript:void(0)" onclick="showLinkDetails(${categoryIndex}, ${JSON.stringify(link).replace(/"/g, '&quot;')})">
                ${isImageFile(link.icon) ? 
                    `<img src="${link.icon}" alt="${link.name}">` : 
                    `<svg class="icon" aria-hidden="true">
                        <use xlink:href="${link.icon}"></use>
                    </svg>`
                }
                <span>${link.name}</span>
            </a>`;
            categoryDiv.appendChild(linkItem);
          });

                    // 添加"添加链接"按钮
                    const addLinkItem = document.createElement('li');
                    addLinkItem.className = "lylme-3 add-link";
                    addLinkItem.innerHTML = `<a href="javascript:void(0)" onclick="addNewLink(${categoryIndex})">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-addlink"></use>
                        </svg>
                        <span>添加链接</span>
                    </a>`;
                    categoryDiv.appendChild(addLinkItem);
                    
          categoriesContainer.appendChild(categoryDiv);
        });

                // 在生成完所有分类后，添加"添加分类"按钮
                const addCategoryDiv = document.createElement('ul');
                addCategoryDiv.className = "mylist row";
                addCategoryDiv.innerHTML = `
                    <li class="title" onclick="addNewCategory()">
                        <svg class="icon" aria-hidden="true">
                            <use href="#icon-add"></use>
                        </svg>
                        <span>添加分类</span>
                    </li>
                `;
                categoriesContainer.appendChild(addCategoryDiv);

        // 设置版权和备案信息
                document.getElementById('copyright').innerHTML = `
                    <div class="text-center">
                        <span class="copyright-wrapper d-inline-block" onclick="showCopyrightDetails(event)">
                            ${config.copyright.show ? 
                                `Copyright ©${config.copyright.text} <span class="copyright-link">${config.copyright.target}</span>. All Rights Reserved.
                                ${config.copyright.showRecord ? 
                                    `<br><span class="record-link">${config.copyright.record}</span>` 
                                    : ''
                                }` 
                                : '<span class="text-muted">点击开启版权信息显示</span>'
                            }
                        </span>
                    </div>
                `;

                // 生成搜索引擎列表
                const searchTypeContainer = document.getElementById('chso');
                searchTypeContainer.innerHTML = ''; // 清空现有内容

                // 添加现有搜索引擎
                config.links.searchEngines.forEach((engine, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <input hidden="" type="radio" name="type" id="${engine.name}" value="${engine.url}" data-placeholder="${engine.placeholder}">
                        <label for="${engine.name}" onclick="showEngineDetails(${index}, ${JSON.stringify(engine).replace(/"/g, '&quot;')})" style="font-weight:600">
                            <svg class="icon" aria-hidden="true">
                                <use xlink:href="${engine.icon}"></use>
                            </svg>
                            <span style="color:#0c498c">${engine.name}</span>
                        </label>
                    `;
                    searchTypeContainer.appendChild(li);
                });

                // 添加"添加搜索引擎"按钮
                const addEngineLi = document.createElement('li');
                addEngineLi.className = "add-engine";
                addEngineLi.innerHTML = `
                    <input hidden="" type="radio" name="type" id="add-engine">
                    <label for="add-engine" onclick="addNewEngine()" style="font-weight:600">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-add"></use>
                        </svg>
                        <span style="color:#0c498c">添加搜索引擎</span>
                    </label>
                `;
                searchTypeContainer.appendChild(addEngineLi);

                // 在所有列表生成完成后初始化 Sortable
                setTimeout(() => {
                    initSortable();
                }, 100);

            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }

      // 检查文件扩展名的函数
      const isImageFile = (url) => /\.(png|jpg|ico|svg)$/.test(url);

        // 页面加载时始化
        loadConfig();
        initSortable();
    </script>

  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarsExample05">
        <svg class="icon" width="200" height="200"><use xlink:href="#icon-menus"></use></svg>
        <span><svg class="bi bi-x" fill="currentColor" id="x"><use xlink:href="#icon-closes"></use></svg></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsExample05">
        <ul class="navbar-nav mr-auto" id="nav-items"></ul>
        <div id="he-plugin-simple"></div>
      </div>				
    </nav>

    <main class="container" style="margin-top:10vh;">
      <div id="main">
        <div id="show_time"></div>  
        <div id="show_date"></div>  
      </div>

      <!-- 搜索框 -->
      <div id="search" class="s-search s-curren">
        <div id="search-list" class="hide-type-list">
          <div class="search-group group-a">
            <div class="search-box">
              <div id="search-lylme">
                <form action="https://cn.bing.com/search?q=" method="get" target="_blank" id="super-search-fm">
                  <div id="checke-so" onclick="lylme()">
                    <svg class="lylme" aria-hidden="true"><use xlink:href="#icon-bing"></use></svg>
                    <svg class="sw" id="lylme-up" style="display:inline" aria-hidden="true"><use xlink:href="#icon-up"></use></svg>
                    <svg class="sw" id="lylme-down" style="display:none" aria-hidden="true"><use xlink:href="#icon-down"></use></svg>
                  </div>
                  <input type="text" id="search-text" placeholder="微软必应搜索" style="outline:0" autocomplete="off">
                  <button class="submit" id="search-submit" type="submit">
                    <svg style="width: 22px; height: 22px; margin: 0 20px; color: #fff;" class="icon" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- 搜索类型选择 -->
		<ul class="search-type" id="chso"></ul>

    

        <div class="set-check hidden-xs">
          <input type="checkbox" id="set-search-blank" class="bubble-3" autocomplete="off">
        </div>
        
        <ul id="word" style="display: none;"></ul>
      </div>

      <!-- 动态生成分类 -->
      <ul class="mylist row" id="categories"></ul>
    </main>

    <!-- 回顶部 -->
    <div style="display:none;" class="back-to" id="toolBackTop">
      <a title="回顶部" onclick="window.scrollTo(0,0);return false;" href="#top" class="back-top"></a>
    </div>

    <!-- 底部信息 -->
    <footer class="mt-5 mb-3 footer text-muted text-center">
      <p id="copyright"></p>
    </footer>

    <script src="js/script.js"></script>
    <script src="assets/js/svg.js"></script>

    <script>
        // 填充导航项数据
        function populateNavItems(navItems) {
            const tbody = document.getElementById("nav-items-table");
            // 清除现有的行
            tbody.innerHTML = '';
            navItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="form-control" value="${item.name}" id="nav-item-name-${index}"></td>
                    <td><input type="text" class="form-control" value="${item.url}" id="nav-item-url-${index}"></td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeNavItem(${index})">删除</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // 填充搜索引擎数据
        function populateSearchEngines(searchEngines) {
            const tbody = document.getElementById("search-engines-table");
            // 清除现有的行
            tbody.innerHTML = '';
            searchEngines.forEach((engine, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="form-control" value="${engine.name}" id="search-engine-name-${index}"></td>
                    <td><input type="text" class="form-control" value="${engine.url}" id="search-engine-url-${index}"></td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeSearchEngine(${index})">删除</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // 填充网导航数据
        function populateCategories(categories) {
            const table = document.getElementById("categories-table");
            // 清除现有的分类行（保留表头）
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            categories.forEach((category, categoryIndex) => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${category.title}" id="category-title-${categoryIndex}"></td>

                    <td><button onclick="removeCategory(${categoryIndex})">删除分类</button></td>
                `;

                const linksDiv = document.createElement('div');
                linksDiv.id = `category-links-${categoryIndex}`;
                row.appendChild(linksDiv);
                populateLinks(category.links, categoryIndex);
            });
        }

        // 填充每个分类的链接
        function populateLinks(links, categoryIndex) {
            const linksDiv = document.getElementById(`category-links-${categoryIndex}`);
            linksDiv.innerHTML = '';
            linksDiv.className = 'mt-3 p-3 bg-light rounded';

            links.forEach((link, linkIndex) => {
                const linkDiv = document.createElement('div');
                linkDiv.className = 'row g-3 mb-2';
                linkDiv.innerHTML = `
                    <div class="col-md-3">
                        <input type="text" class="form-control" value="${link.name}" id="link-name-${categoryIndex}-${linkIndex}" placeholder="名称">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" value="${link.url}" id="link-url-${categoryIndex}-${linkIndex}" placeholder="链��">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" value="${link.icon}" id="link-icon-${categoryIndex}-${linkIndex}" placeholder="图标">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm w-100" onclick="removeLink(${categoryIndex}, ${linkIndex})">删除</button>
                    </div>
                `;
                linksDiv.appendChild(linkDiv);
            });

            // 添加链接按钮
            const addLinkButton = document.createElement('button');
            addLinkButton.textContent = '添加新链接';
            addLinkButton.className = 'btn btn-primary mt-2';
            addLinkButton.onclick = function() {
                addLink(categoryIndex);
            };
            linksDiv.appendChild(addLinkButton);
        }

        // 添加链接
        function addLink(categoryIndex) {
            // 默认链接数据
            const newLink = { 
                name: '', 
                url: '', 
                icon: '' 
            };

            // 将新链接添加到该分类
            configData.links.categories[categoryIndex].links.push(newLink);
            populateLinks(configData.links.categories[categoryIndex].links, categoryIndex);  // 更新链接显示
        }

        // 删除链接
        function removeLink(categoryIndex, linkIndex) {
            configData.links.categories[categoryIndex].links.splice(linkIndex, 1);  // 删除该链接
            populateLinks(configData.links.categories[categoryIndex].links, categoryIndex);  // 更新链接显示
        }

        // 删除分类
        function removeCategory(categoryIndex) {
            configData.links.categories.splice(categoryIndex, 1);
            populateCategories(configData.links.categories);  // 直接更新分类显示
        }

        // 删除导航项
        function removeNavItem(index) {
            configData.links.navItems.splice(index, 1);
            populateNavItems(configData.links.navItems);  // 直接更新导航项显示
        }

        // 删除搜索引擎
        function removeSearchEngine(index) {
            configData.links.searchEngines.splice(index, 1);
            populateSearchEngines(configData.links.searchEngines);  // 直接更新搜索引擎显示
        }

        // 修改 saveConfig 函数
        async function saveConfig() {
            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                console.log('配置保存成功:', result);
            } catch (error) {
                console.error('保存配置失败:', error);
                throw error; // 继续抛出错误以便调用者处理
            }
        }

        // 添加导航项
        function addNavItem() {
            const name = document.getElementById("new-nav-item-name").value;
            const url = document.getElementById("new-nav-item-url").value;

            if (name && url) {
                const newItem = { name, url };
                configData.links.navItems.push(newItem);  // 将新项添加到配置数据中
                populateNavItems(configData.links.navItems);  // 更新导航项显示
                document.getElementById("new-nav-item-name").value = '';  // 清空输入框
                document.getElementById("new-nav-item-url").value = '';  // 清空输入框
            } else {
                alert("请填写名称和链接");
            }
        }

        // 添加���索引擎
        function addSearchEngine() {
            const name = document.getElementById("new-search-engine-name").value;
            const url = document.getElementById("new-search-engine-url").value;

            if (name && url) {
                const newEngine = { name, url };
                configData.links.searchEngines.push(newEngine);  // 将新搜索引擎添加到配置数据中
                populateSearchEngines(configData.links.searchEngines);  // 更新搜索引擎显示
                document.getElementById("new-search-engine-name").value = '';  // 清空输入框
                document.getElementById("new-search-engine-url").value = '';  // 清空输入框
            } else {
                alert("请填写名称和链接");
            }
        }

        // 添加新分类
        function addCategory() {
            const title = document.getElementById("new-category-title").value;
            
            if (title) {
                const newCategory = {
                    title: title,
                    links: []  // 分类初始化为链接数组
                };
                
                configData.links.categories.push(newCategory);
                document.getElementById("new-category-title").value = '';  // 清空输入框
                
                // 重新加载分类显示
                const table = document.getElementById("categories-table");
                // 清除现有分类行（保留表头）
                while (table.rows.length > 1) {
                    table.deleteRow(1);
                }
                populateCategories(configData.links.categories);
            } else {
                alert("请填写分类名称");
            }
        }

        // 切换显示/隐藏链接
        function toggleLinks(categoryIndex) {
            const linksDiv = document.getElementById(`category-links-${categoryIndex}`);
            const currentDisplay = window.getComputedStyle(linksDiv).display;
            if (currentDisplay === 'none') {
                linksDiv.style.display = 'block';
            } else {
                linksDiv.style.display = 'none';
            }
        }

        // 添加新链接的函数
        function addNewLink(categoryIndex) {
            // 清空表单
            document.getElementById('linkName').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('linkIcon').value = '';
            
            // 设置分类索引
            document.getElementById('addLinkCategoryIndex').value = categoryIndex;
            
            // 显示模态框
            $('#addLinkModal').modal('show');
        }

        // 保存新链接
        async function saveNewLink() {
            try {
                const categoryIndex = parseInt(document.getElementById('addLinkCategoryIndex').value);
                const name = document.getElementById('linkName').value;
                const url = document.getElementById('linkUrl').value;
                const icon = document.getElementById('linkIcon').value;

                // 验证必填字段
                if (!name || !url) {
                    throw new Error('请填写名称和链接地址');
                }

                // 创建新链接对象
                const newLink = {
                    name: name,
                    url: url,
                    icon: icon || '#icon-link' // 如果没有提供图标，使用默认图标
                };

                // 添加到配置中
                configData.links.categories[categoryIndex].links.push(newLink);

                // 保存配置
                await saveConfig();

                // 关闭模态框并重新加载
                $('#addLinkModal').modal('hide');
                await loadConfig();

            } catch (error) {
                console.error('保存链接失败:', error);
                alert(error.message || '保存失败，请重试');
            }
        }

        // 显示链接详情
        function showLinkDetails(categoryIndex, link) {
            document.getElementById('linkDetailsCategoryIndex').value = categoryIndex;
            document.getElementById('linkDetailsName').value = link.name || '';
            document.getElementById('linkDetailsUrl').value = link.url || '';
            document.getElementById('linkDetailsIcon').value = link.icon || '';

            // 存储当前链接在分类中的索引
            const linkIndex = configData.links.categories[categoryIndex].links.findIndex(l => 
                l.name === link.name && l.url === link.url && l.icon === link.icon
            );
            document.getElementById('linkDetailsIndex').value = linkIndex;

            $('#linkDetailsModal').modal('show');
        }

        // 保存链接更改
        async function saveCurrentLink() {
            try {
                const categoryIndex = parseInt(document.getElementById('linkDetailsCategoryIndex').value);
                const linkIndex = parseInt(document.getElementById('linkDetailsIndex').value);
                
                // 获取表单数据
                const updatedLink = {
                    name: document.getElementById('linkDetailsName').value,
                    url: document.getElementById('linkDetailsUrl').value,
                    icon: document.getElementById('linkDetailsIcon').value
                };

                // 验证必填字段
                if (!updatedLink.name || !updatedLink.url) {
                    throw new Error('请填写名称和链接地址');
                }

                // 更新配置
                configData.links.categories[categoryIndex].links[linkIndex] = updatedLink;

                // 保存配置
                await saveConfig();

                // 关闭模态框并重新加载
                $('#linkDetailsModal').modal('hide');
                await loadConfig();

            } catch (error) {
                console.error('保存链接失败:', error);
                alert(error.message || '保存失败，请重试');
            }
        }

        // 删除当前链接
        async function deleteCurrentLink() {
            if (!confirm('确定要删除这个链接吗？')) return;

            try {
                const categoryIndex = parseInt(document.getElementById('linkDetailsCategoryIndex').value);
                const linkIndex = parseInt(document.getElementById('linkDetailsIndex').value);

                // 从数组中删除链接
                configData.links.categories[categoryIndex].links.splice(linkIndex, 1);

                // 保��配置
                await saveConfig();

                // 关闭模态框并重新加载
                $('#linkDetailsModal').modal('hide');
                await loadConfig();

            } catch (error) {
                console.error('删除链接失败:', error);
                alert('删除失败，请重试');
            }
        }

        // 显示搜索引擎详情
        function showEngineDetails(index, engine) {
            document.getElementById('engineDetailsIndex').value = index;
            document.getElementById('engineDetailsName').value = engine.name;
            document.getElementById('engineDetailsUrl').value = engine.url;
            document.getElementById('engineDetailsIcon').value = engine.icon;
            document.getElementById('engineDetailsPlaceholder').value = engine.placeholder || '';
            $('#engineDetailsModal').modal('show');
        }

        // 保存搜索引擎更改
        async function saveCurrentEngine() {
            try {
                const index = document.getElementById('engineDetailsIndex').value;
                const name = document.getElementById('engineDetailsName').value;
                const url = document.getElementById('engineDetailsUrl').value;
                const icon = document.getElementById('engineDetailsIcon').value;
                const placeholder = document.getElementById('engineDetailsPlaceholder').value;

                if (!name || !url || !icon) {
                    throw new Error('请填写必填项');
                }

                configData.links.searchEngines[index] = { 
                    name, 
                    url, 
                    icon, 
                    placeholder: placeholder || `${name}搜索` 
                };
                await saveConfig();
                $('#engineDetailsModal').modal('hide');
                await loadConfig();
            } catch (error) {
                alert(error.message || '保存失败');
            }
        }

        // 删除当前搜索引擎
        async function deleteCurrentEngine() {
            if (!confirm('确定要删除这个搜索引擎吗？')) return;
            
            try {
                const index = document.getElementById('engineDetailsIndex').value;
                configData.links.searchEngines.splice(index, 1);
                await saveConfig();
                $('#engineDetailsModal').modal('hide');
                await loadConfig();
            } catch (error) {
                alert('删除失败');
            }
        }

        // 显示导航项详情
        function showNavDetails(index, item) {
            document.getElementById('navDetailsIndex').value = index;
            document.getElementById('navDetailsName').value = item.name;
            document.getElementById('navDetailsUrl').value = item.url;
            document.getElementById('navDetailsId').value = item.id || '';
            $('#navDetailsModal').modal('show');
        }

        // 保存导航项更改
        async function saveCurrentNav() {
            try {
                const index = document.getElementById('navDetailsIndex').value;
                const name = document.getElementById('navDetailsName').value;
                const url = document.getElementById('navDetailsUrl').value;
                const id = document.getElementById('navDetailsId').value;

                if (!name || !url) {
                    throw new Error('请填写必填项');
                }

                configData.links.navItems[index] = { 
                    name, 
                    url, 
                    id: id || name 
                };
                await saveConfig();
                $('#navDetailsModal').modal('hide');
                await loadConfig();
            } catch (error) {
                alert(error.message || '保存失败');
            }
        }

        // 删除当前导航项
        async function deleteCurrentNav() {
            if (!confirm('确定要删除这个导航项吗？')) return;
            
            try {
                const index = document.getElementById('navDetailsIndex').value;
                configData.links.navItems.splice(index, 1);
                await saveConfig();
                $('#navDetailsModal').modal('hide');
                await loadConfig();
            } catch (error) {
                alert('删除失败');
            }
        }

        // 显示分类详情
        function showCategoryDetails(index, category) {
            document.getElementById('categoryDetailsIndex').value = index;
            document.getElementById('categoryDetailsTitle').value = category.title;
            document.getElementById('categoryDetailsIcon').value = category.icon;
            $('#categoryDetailsModal').modal('show');
        }

        // 保存分类更改
        async function saveCurrentCategory() {
            try {
                const index = document.getElementById('categoryDetailsIndex').value;
                const title = document.getElementById('categoryDetailsTitle').value;
                const icon = document.getElementById('categoryDetailsIcon').value;

                if (!title || !icon) {
                    throw new Error('请填写所有必填项');
                }

                // 保持原有的链接变
                const links = configData.links.categories[index].links;
                configData.links.categories[index] = { 
                    title, 
                    icon,
                    links 
                };

                await saveConfig();
                $('#categoryDetailsModal').modal('hide');
                await loadConfig();
            } catch (error) {
                console.error('操作失败:', error);
                alert(error.message || '保存失败');
            }
        }

        // 删除当前分类
        async function deleteCurrentCategory() {
            if (!confirm('确定要删除这个分类吗？这将同时删除该分类下的所有链接！')) return;
            
            try {
                const index = document.getElementById('categoryDetailsIndex').value;
                configData.links.categories.splice(index, 1);
                await saveConfig();
                $('#categoryDetailsModal').modal('hide');
                await loadConfig();
            } catch (error) {
                console.error('操作失败:', error);
                alert('删除失败');
            }
        }

        // 显示版权设置
        function showCopyrightDetails(event) {
            // 阻止事件冒泡和默认行为
            event.preventDefault();
            event.stopPropagation();

            // 设置当前值
            document.getElementById('showCopyright').checked = configData.copyright.show !== false;
            document.getElementById('copyrightText').value = configData.copyright.text || '';
            document.getElementById('copyrightTarget').value = configData.copyright.target || '';
            document.getElementById('showRecord').checked = configData.copyright.showRecord !== false;
            document.getElementById('copyrightRecord').value = configData.copyright.record || '';
            document.getElementById('copyrightRecordUrl').value = configData.copyright.recordUrl || '';

            // 根据开关态显示/隐藏相关字段
            toggleCopyrightFields();
            toggleRecordFields();

            // 显示模态框
            $('#copyrightModal').modal('show');
        }

        // 切换版权字段显示状态
        function toggleCopyrightFields() {
            const showCopyright = document.getElementById('showCopyright').checked;
            document.getElementById('copyrightFields').style.display = showCopyright ? 'block' : 'none';
        }

        // 切���备案字段显示状态
        function toggleRecordFields() {
            const showRecord = document.getElementById('showRecord').checked;
            document.getElementById('recordFields').style.display = showRecord ? 'block' : 'none';
        }

        // 保存版权设置
        async function saveCopyrightSettings() {
            try {
                const showCopyright = document.getElementById('showCopyright').checked;
                const showRecord = document.getElementById('showRecord').checked;

                configData.copyright = {
                    show: showCopyright,
                    text: document.getElementById('copyrightText').value,
                    target: document.getElementById('copyrightTarget').value,
                    showRecord: showRecord,
                    record: document.getElementById('copyrightRecord').value,
                    recordUrl: document.getElementById('copyrightRecordUrl').value
                };

                await saveConfig();
                $('#copyrightModal').modal('hide');
                await loadConfig();
            } catch (error) {
                console.error('保存失败:', error);
                alert('保存失败，请重试');
            }
        }

        // 添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('showCopyright').addEventListener('change', toggleCopyrightFields);
            document.getElementById('showRecord').addEventListener('change', toggleRecordFields);
        });

        // 修改 initSortable 函数
        function initSortable() {
            // 导航项排序
            const navList = document.getElementById('nav-items');
            if (navList) {
                new Sortable(navList, {
                    animation: 150,
                    handle: '.nav-link',  // 通过导航链接拖动
                    filter: '.add-nav',   // 排除加按钮
                    onEnd: async function(evt) {
                        try {
                            const items = [...configData.links.navItems];
                            const item = items.splice(evt.oldIndex, 1)[0];
                            items.splice(evt.newIndex, 0, item);
                            configData.links.navItems = items;
                            await saveConfig();
                        } catch (error) {
                            console.error('保存排序失败:', error);
                            await loadConfig(); // 如果保存失败，重新加载
                        }
                    }
                });
            }

            // 搜索引擎排序
            const searchList = document.getElementById('chso');
            if (searchList) {
                new Sortable(searchList, {
                    animation: 150,
                    handle: 'label',     // 通过标签拖动
                    filter: '.add-engine', // 排除添加按钮
                    onEnd: async function(evt) {
                        try {
                            const items = [...configData.links.searchEngines];
                            const item = items.splice(evt.oldIndex, 1)[0];
                            items.splice(evt.newIndex, 0, item);
                            configData.links.searchEngines = items;
                            await saveConfig();
                        } catch (error) {
                            console.error('保存排序失败:', error);
                            await loadConfig();
                        }
                    }
                });
            }

            // 分类排序
            const categoriesList = document.getElementById('categories');
            if (categoriesList) {
                new Sortable(categoriesList, {
                    animation: 150,
                    handle: '.title',    // 通过标题拖动
                    filter: '.add-category', // 排除添加按钮
                    draggable: '.mylist:not(.add-category)', // 允许拖动非添加按钮的分类
                    delay: 10, // 添加延迟，区分点击和拖动
                    delayOnTouchOnly: true, // 仅在触摸设备上添加延迟
                    onStart: function(evt) {
                        // 阻止点击事件
                        evt.item.querySelector('.category-title').onclick = null;
                    },
                    onEnd: async function(evt) {
                        try {
                            if (evt.oldIndex === evt.newIndex) {
                                // 如果位置没有改变，恢复点击事件
                                const categoryIndex = evt.oldIndex;
                                const category = configData.links.categories[categoryIndex];
                                evt.item.querySelector('.category-title').onclick = () => 
                                    showCategoryDetails(categoryIndex, category);
                                return;
                            }

                            // 获取所有分类（排添加分类按钮）
                            const categories = [...configData.links.categories];
                            
                            // 移动分类
                            const category = categories.splice(evt.oldIndex, 1)[0];
                            categories.splice(evt.newIndex, 0, category);
                            
                            // 更新配置
                            configData.links.categories = categories;
                            
                            // 保存配置
                            await saveConfig();
                            console.log('分类排序已保存', {
                                fromIndex: evt.oldIndex,
                                toIndex: evt.newIndex,
                                category: category.title
                            });

                            // 重新加载以恢复所有事件绑定
                            await loadConfig();
                        } catch (error) {
                            console.error('保存排序失败:', error);
                            alert('保存排序失败，即将重新加载页面');
                            await loadConfig();
                        }
                    }
                });
            }

            // 链接排序 - 持跨分类拖动
            document.querySelectorAll('.mylist').forEach((list) => {
                if (!list.classList.contains('add-category')) {
                    new Sortable(list, {
                        animation: 150,
                        handle: '.lylme-3',  // 通过链接项拖动
                        filter: '.add-link, .title', // 排除添加按钮和标题
                        group: 'links',  // 添加组名，允许跨列表拖动
                        onEnd: async function(evt) {
                            try {
                                if (evt.oldIndex === evt.newIndex && evt.from === evt.to) return;

                                // 获取源分类和目标分类的标题
                                const fromTitle = evt.from.querySelector('.title span').textContent;
                                const toTitle = evt.to.querySelector('.title span').textContent;

                                // 根据标题到对应的分类索引
                                const fromCategoryIndex = configData.links.categories.findIndex(c => c.title === fromTitle);
                                const toCategoryIndex = configData.links.categories.findIndex(c => c.title === toTitle);

                                if (fromCategoryIndex === -1 || toCategoryIndex === -1) {
                                    throw new Error('找不到对应的分类');
                                }

                                // 获取源分类和目标分类的链接数组
                                const fromLinks = [...configData.links.categories[fromCategoryIndex].links];
                                const toLinks = fromCategoryIndex === toCategoryIndex ? 
                                    fromLinks : 
                                    [...configData.links.categories[toCategoryIndex].links];

                                // 移动链接
                                const link = fromLinks.splice(evt.oldIndex - 1, 1)[0]; // -1 因为标题占用了第一个位置
                                toLinks.splice(evt.newIndex - 1, 0, link);

                                // 更新配置
                                configData.links.categories[fromCategoryIndex].links = fromLinks;
                                if (fromCategoryIndex !== toCategoryIndex) {
                                    configData.links.categories[toCategoryIndex].links = toLinks;
                                }

                                // 保存配置
                                await saveConfig();
                                console.log('链接排序已保存', {
                                    fromCategory: fromTitle,
                                    toCategory: toTitle,
                                    fromIndex: evt.oldIndex - 1,
                                    toIndex: evt.newIndex - 1,
                                    link: link
                                });

                            } catch (error) {
                                console.error('保存排序失败:', error);
                                alert('保存排序失败，即将重新加载页面');
                                await loadConfig(); // 如果保存失败，重新加载配置
                            }
                        }
                    });
                }
            });
        }

        // 修改自动获取链接信息的函数
        async function autoFetchLinkInfo() {
            // 确定当前是哪个模态框
            const isDetailsModal = $('#linkDetailsModal').is(':visible');
            const isAddModal = $('#addLinkModal').is(':visible');
            
            // 获取当前模态框中的输入元素
            const urlInput = isDetailsModal ? 
                document.getElementById('linkDetailsUrl') : 
                document.getElementById('linkUrl');
            const nameInput = isDetailsModal ? 
                document.getElementById('linkDetailsName') : 
                document.getElementById('linkName');
            const iconInput = isDetailsModal ? 
                document.getElementById('linkDetailsIcon') : 
                document.getElementById('linkIcon');

            let url = urlInput.value.trim();
            
            if (!url) {
                alert('请先输入链接地址');
                return;
            }

            // 自动补全 URL
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
                urlInput.value = url;
            }

            // 保存按钮的原始状态
            const button = event.currentTarget;
            const originalContent = button.innerHTML;
            
            try {
                // 显示加载状态
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                // 调用服务器接口获取网���信息
                const response = await fetch(`/fetch-site-info?url=${encodeURIComponent(url)}`);
                if (!response.ok) {
                    // 如果 https 失败，尝试 http
                    if (url.startsWith('https://')) {
                        url = 'http://' + url.substring(8);
                        urlInput.value = url;
                        const retryResponse = await fetch(`/fetch-site-info?url=${encodeURIComponent(url)}`);
                        if (!retryResponse.ok) {
                            throw new Error('获取网站信息失败');
                        }
                        const data = await retryResponse.json();
                        if (data.title) {
                            nameInput.value = data.title;
                        }
                        if (data.favicon) {
                            iconInput.value = data.favicon;
                        }
                        return;
                    }
                    throw new Error('获取网站信息失败');
                }

                const data = await response.json();
                console.log('获取到的网站信息:', data);
                
                // 填充表单
                if (data.title) {
                    nameInput.value = data.title;
                    console.log('设置链接名称为:', data.title);
                }
                if (data.favicon) {
                    iconInput.value = data.favicon;
                    console.log('设置图标地址为:', data.favicon);
                }

            } catch (error) {
                console.error('获取链接信息失败:', error);
                alert('获取失败，请手动输入');
            } finally {
                // 无论成功还是失败，都恢复按钮状态
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }
    </script>

    <!-- 在 body 标签结束前添加模态框 -->
    <div class="modal fade" id="addLinkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新链接</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addLinkForm">
                        <input type="hidden" id="addLinkCategoryIndex">
                        <div class="form-group">
                            <label>链接名称</label>
                            <input type="text" class="form-control" id="linkName">
                        </div>
                        <div class="form-group">
                            <label>链接地址</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="linkUrl">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="autoFetchLinkInfo()">
                                        <svg class="icon" aria-hidden="true" style="width: 16px; height: 16px;">
                                            <use xlink:href="#icon-sousuo"></use>
                                        </svg>
                                        <span>自动获取</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>图标</label>
                            <input type="text" class="form-control" id="linkIcon">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewLink()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在 body 标签结束前添加搜索引擎态 -->
    <div class="modal fade" id="addEngineModal" tabindex="-1" aria-labelledby="addEngineModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEngineModalLabel">添加搜索引擎</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addEngineForm">
                        <div class="form-group">
                            <label for="engineName">搜索引擎名称</label>
                            <input type="text" class="form-control" id="engineName" required>
                        </div>
                        <div class="form-group">
                            <label for="engineUrl">搜索URL</label>
                            <input type="url" class="form-control" id="engineUrl" required>
                            <small class="form-text text-muted">使用 %s 代替搜索键词，如：https://www.google.com/search?q=%s</small>
                        </div>
                        <div class="form-group">
                            <label for="engineIcon">图标代码</label>
                            <input type="text" class="form-control" id="engineIcon" required>
                        </div>
                        <div class="form-group">
                            <label for="enginePlaceholder">搜索框示文字</label>
                            <input type="text" class="form-control" id="enginePlaceholder">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveEngine">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 添加新搜索引擎的函数
    function addNewEngine() {
        // 清空表单
        document.getElementById('engineName').value = '';
        document.getElementById('engineUrl').value = '';
        document.getElementById('engineIcon').value = '';
        document.getElementById('enginePlaceholder').value = '';
        
        // 显示模态框
        $('#addEngineModal').modal('show');
        
        // 保存按钮点击事件
        document.getElementById('saveEngine').onclick = async function() {
            try {
                const engineName = document.getElementById('engineName').value;
                const engineUrl = document.getElementById('engineUrl').value;
                const engineIcon = document.getElementById('engineIcon').value;
                const enginePlaceholder = document.getElementById('enginePlaceholder').value;
                
                if (!engineName || !engineUrl || !engineIcon) {
                    throw new Error('请填写必填项');
                }

                // 创建搜索引擎对象
                const newEngine = {
                    name: engineName,
                    url: engineUrl,
                    icon: engineIcon,
                    placeholder: enginePlaceholder || `${engineName}搜索`
                };

                // 添加到配置中
                configData.links.searchEngines.push(newEngine);

                // 保存配置
                await saveConfig();
                $('#addEngineModal').modal('hide');  // 关闭模态框
                
                // 重新加载配置
                await loadConfig();
                
            } catch (error) {
                console.error('操作失败:', error);
                alert(error.message || '添加搜索引擎失败，请重试');
            }
        };
    }
    </script>

    <!-- 在 body 标签结束前添加导航项模态框 -->
    <div class="modal fade" id="addNavModal" tabindex="-1" aria-labelledby="addNavModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addNavModalLabel">添加导航项</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addNavForm">
                        <div class="form-group">
                            <label for="navName">导航名称</label>
                            <input type="text" class="form-control" id="navName" required>
                        </div>
                        <div class="form-group">
                            <label for="navUrl">链接地址</label>
                            <input type="url" class="form-control" id="navUrl" required>
                        </div>
                        <div class="form-group">
                            <label for="navId">ID (可选)</label>
                            <input type="text" class="form-control" id="navId">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveNav">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 添加新导航项的函数
    function addNewNavItem() {
        // 清空表单
        document.getElementById('navName').value = '';
        document.getElementById('navUrl').value = '';
        document.getElementById('navId').value = '';
        
        // 显示模态框
        $('#addNavModal').modal('show');
        
        // 保存按钮点击事件
        document.getElementById('saveNav').onclick = async function() {
            try {
                const navName = document.getElementById('navName').value;
                const navUrl = document.getElementById('navUrl').value;
                const navId = document.getElementById('navId').value;
                
                if (!navName || !navUrl) {
                    throw new Error('请填写必填项');
                }

                // 创建新导航项对象
                const newNavItem = {
                    name: navName,
                    url: navUrl,
                    id: navId || navName // 如果没提供 ID，使用名称作为 ID
                };

                // 添加到配置
                configData.links.navItems.push(newNavItem);

                // 保存配置
                await saveConfig();
                $('#addNavModal').modal('hide');  // 关闭模态框
                
                // 重新加载配置
                await loadConfig();
                
            } catch (error) {
                console.error('操作失败:', error);
                alert(error.message || '添加导航项失败，请重试');
            }
        };
    }
    </script>

    <!-- 添加链接详情模态框 -->
    <div class="modal fade" id="linkDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">链接详情</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="linkDetailsForm">
                        <input type="hidden" id="linkDetailsCategoryIndex">
                        <input type="hidden" id="linkDetailsIndex">
                        <div class="form-group">
                            <label>链接名称</label>
                            <input type="text" class="form-control" id="linkDetailsName">
                        </div>
                        <div class="form-group">
                            <label>链接地址</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="linkDetailsUrl">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="autoFetchLinkInfo()">
                                        <svg class="icon" aria-hidden="true" style="width: 16px; height: 16px;">
                                            <use xlink:href="#icon-sousuo"></use>
                                        </svg>
                                        <span>自动获取</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>图标</label>
                            <input type="text" class="form-control" id="linkDetailsIcon">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentLink()">删除</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="saveCurrentLink()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加搜索引擎详情模态框 -->
    <div class="modal fade" id="engineDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">搜索引擎详情</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="engineDetailsForm">
                        <input type="hidden" id="engineDetailsIndex">
                        <div class="form-group">
                            <label>搜索引擎名称</label>
                            <input type="text" class="form-control" id="engineDetailsName">
                        </div>
                        <div class="form-group">
                            <label>搜索URL</label>
                            <input type="url" class="form-control" id="engineDetailsUrl">
                        </div>
                        <div class="form-group">
                            <label>图标代码</label>
                            <input type="text" class="form-control" id="engineDetailsIcon">
                        </div>
                        <div class="form-group">
                            <label>搜索框提示文字</label>
                            <input type="text" class="form-control" id="engineDetailsPlaceholder">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentEngine()">删除</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="saveCurrentEngine()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加导航项详情模态框 -->
    <div class="modal fade" id="navDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">导航项详情</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="navDetailsForm">
                        <input type="hidden" id="navDetailsIndex">
                        <div class="form-group">
                            <label>导航名称</label>
                            <input type="text" class="form-control" id="navDetailsName">
                        </div>
                        <div class="form-group">
                            <label>链接地址</label>
                            <input type="url" class="form-control" id="navDetailsUrl">
                        </div>
                        <div class="form-group">
                            <label>ID</label>
                            <input type="text" class="form-control" id="navDetailsId">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentNav()">删除</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="saveCurrentNav()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加分类详情模态框 -->
    <div class="modal fade" id="categoryDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">分类详情</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="categoryDetailsForm">
                        <input type="hidden" id="categoryDetailsIndex">
                        <div class="form-group">
                            <label>分类名称</label>
                            <input type="text" class="form-control" id="categoryDetailsTitle">
                        </div>
                        <div class="form-group">
                            <label>图标代码</label>
                            <input type="text" class="form-control" id="categoryDetailsIcon">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentCategory()">删除</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="saveCurrentCategory()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加新分类的模态框 -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新分类</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="form-group">
                            <label>分类名称</label>
                            <input type="text" class="form-control" id="newCategoryTitle" required>
                        </div>
                        <div class="form-group">
                            <label>图标代码</label>
                            <input type="text" class="form-control" id="newCategoryIcon" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewCategory()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 添加新分类的函数
    function addNewCategory() {
        // 清空表单
        document.getElementById('newCategoryTitle').value = '';
        document.getElementById('newCategoryIcon').value = '';
        
        // 显示模态框
        $('#addCategoryModal').modal('show');
    }

    // 保存新分类
    async function saveNewCategory() {
        try {
            const title = document.getElementById('newCategoryTitle').value;
            const icon = document.getElementById('newCategoryIcon').value;

            if (!title || !icon) {
                throw new Error('请填写所有必填项');
            }

            // 创建新分类对象
            const newCategory = {
                title,
                icon,
                links: [] // 新分类初始没有链接
            };

            // 添加到配置中
            configData.links.categories.push(newCategory);

            // 保存配置
            await saveConfig();
            $('#addCategoryModal').modal('hide');
            
            // 重新加载配置
            await loadConfig();
            
        } catch (error) {
            console.error('操作失败:', error);
            alert(error.message || '添加分类失败，请重试');
        }
    }
    </script>

    <!-- 添加版权设置模态框 -->
    <div class="modal fade" id="copyrightModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">版权设置</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="copyrightForm">
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="showCopyright">
                                <label class="custom-control-label" for="showCopyright">显示版权信息</label>
                            </div>
                        </div>
                        <div id="copyrightFields">
                            <div class="form-group">
                                <label>版权文本</label>
                                <input type="text" class="form-control" id="copyrightText">
                            </div>
                            <div class="form-group">
                                <label>版权链接目标</label>
                                <input type="text" class="form-control" id="copyrightTarget">
                            </div>
                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="showRecord">
                                    <label class="custom-control-label" for="showRecord">显示备案信息</label>
                                </div>
                            </div>
                            <div id="recordFields">
                                <div class="form-group">
                                    <label>备案号</label>
                                    <input type="text" class="form-control" id="copyrightRecord">
                                </div>
                                <div class="form-group">
                                    <label>备案链接</label>
                                    <input type="url" class="form-control" id="copyrightRecordUrl">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCopyrightSettings()">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
